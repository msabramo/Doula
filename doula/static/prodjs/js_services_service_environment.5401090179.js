_mixin=function(target,source){for(var x in source){target[x]=source[x];}};var EventUtil={onclick:function(selector,func){$(selector).on('click',$.proxy(function(event){func=$.proxy(func,this);func(event);return false;},this));}};var DataEventManager={subscribe:function(event,fn){$(this).bind(event,fn);},publish:function(event,data){$(this).trigger(event,data);}};_inArray=function(key,array,attribute){for(var i=0;i<array.length;i++){var item=array[i];if(typeof(item)=='object'){if(key==item[attribute])return item;}
else{if(key==item)return item;}}
return false;};_withoutArray=function(array,key,attribute){var arrayWithout=[];for(var i=0;i<array.length;i++){var item=array[i];if(typeof(item)=='object'){if(array!=item[attribute])arrayWithout.push(item);}
else{if(array!=item)arrayWithout.push(item);}}
return arrayWithout;};var AJAXUtil={post:function(url,params,onDone,onFail,msg){this._send('POST',url,params,onDone,onFail,msg);},get:function(url,params,onDone,onFail,msg){this._send('GET',url,params,onDone,onFail,msg);},_send:function(type,url,params,onDone,onFail,msg){onDone=$.proxy(onDone,this);if(typeof(onFail)=='function')onFail=$.proxy(onFail,this);if(msg)Notifier.info(msg,false);$.ajax({url:url,type:type,data:this._getDataValues(params),error:function(){if(typeof(onFail)=='function'){onFail(rslt);}
else{AJAXUtil._showStandardErrorMessage(rslt);}},success:function(response){try{if(msg){setTimeout(function(){Notifier.hide();},1500);}
rslt=(typeof(response)=='string')?$.parseJSON(response):response;if(rslt.success){onDone(rslt);}
else{if(typeof(onFail)=='function'){onFail(rslt);}
else{AJAXUtil._showStandardErrorMessage(rslt);}}}
catch(err){onDone(response);}}});},_getDataValues:function(params){var dataValues='';var count=0;for(var key in params){if(dataValues!=='')dataValues+='&';dataValues+=key+'='+encodeURIComponent(params[key]);}
return dataValues;},_showStandardErrorMessage:function(rslt){$('#modal-error').on('show',function(){$('#modal-error-msg').html(rslt.msg);$('#modal-error-close').on('click',function(){$('#modal-error').modal('hide');return false;});});$('#modal-error').modal();}};;QueueView={MAX_SERVICE_JOB_COUNT:3,limitInitialQueueItems:false,firstRun:true,jobQueueCount:0,jobsAndStatuses:{},queueFilters:{},bucket_id:0,last_updated:0,pollInterval:2000,init:function(kwargs){_mixin(this,AJAXUtil);_mixin(this,DataEventManager);this.queueFilters=__queueFilters;this.queueFilters.bucket_id=this.bucket_id;this.queueFilters.last_updated=this.last_updated;if(this.queueFilters.service){this.pollInterval=1000;this.limitInitialQueueItems=true;}
this.bindToUIActions();},bindToUIActions:function(){this.selectFilterByAndSortByLabels();this.poll();},selectFilterByAndSortByLabels:function(){var sortBy=this.queueFilters.sort_by;var filterBy=this.queueFilters.filter_by;$('ul.sort_by a').each(function(index,el){el=$(el);if(el.hasClass('sort_by')){if(el.attr('data-val')==sortBy){el.addClass('active');}
else{el.removeClass('active');}
el.attr('href','/queue?sort_by='+
el.attr('data-val')+'&filter_by='+filterBy);}
else{if(el.attr('data-val')==filterBy){el.addClass('active');}
else{el.removeClass('active');}
el.attr('href','/queue?sort_by='+
sortBy+'&filter_by='+el.attr('data-val'));}});},poll:function(){this.queueFilters.job_ids=JSON.stringify(this.getJobIDs());this.post('/queue',this.queueFilters,$.proxy(this.updateJobStatuses,this),$.proxy(this.failedJobUpdateStatus,this),false);},getJobIDs:function(){return $.map(this.jobsAndStatuses,function(value,key){return key;});},failedJobUpdateStatus:function(){this.pollAgain();},updateJobStatuses:function(data){if(data.has_changed){this.queueFilters.bucket_id=data.query_bucket.id;this.queueFilters.last_updated=data.query_bucket.last_updated;var jobIDs=this.getJobIDs();if(data.query_bucket.jobs.length)$('#no-queue-items-warning').hide();$.each(data.query_bucket.jobs.reverse(),$.proxy(function(index,job){if(jobIDs.length){if(jobIDs.indexOf(job.id)>-1){if(this.jobsAndStatuses[job.id]!=job.status){$("#queue-jobs .queued_item[data-id='"+job.id+"']").replaceWith(job.html);QueueView.publish('queue-item-changed',job);}}
else{$('#queue-jobs').prepend(job.html);}
this.jobsAndStatuses[job.id]=job.status;}
else{if(this.jobQueueCount<this.MAX_SERVICE_JOB_COUNT||!this.limitInitialQueueItems){if(!this.jobsAndStatuses[job.id]){$('#queue-jobs').append(job.html);this.jobQueueCount+=1;}}
this.jobsAndStatuses[job.id]=job.status;}},this));}
if(this.firstRun){this.firstRun=false;this.showTheSelectedJobLog();}
this.pollAgain();},pollAgain:function(){setTimeout($.proxy(function(){this.poll();},this),this.pollInterval);},showTheSelectedJobLog:function(){if($(document.location.hash).length){$(document.location.hash).click();$(document).scrollTop($(document.location.hash).offset().top);}}};$(document).ready(function(){QueueView.init();});;var Data={githubRepos:'',init:function(){_mixin(this,__service);},findGitHubRepo:function(name){for(var repoName in this.githubRepos){if(repoName==name){return this.githubRepos[name];}}
return false;}};;var ServiceEnv={init:function(){this.releases=__releases;_mixin(this,AJAXUtil);Data.init();this.bindToUIActions();this.bindToDataActions();},bindToUIActions:function(){$('a[rel="tooltip"]').tooltip({"delay":{"show":500,"hide":100}});$(".hide-on-load").each(function(index,el){$(el).show();});$('.commit-accordion').on('show',function(){$(this).parent().removeClass('hidden').addClass('shown');});$('.commit-accordion').on('hide',function(){$(this).parent().removeClass('shown').addClass('hidden');});this.addVersionMessageBelowPackageSelects();$('#release-service').popover({placement:"bottom"});$('a.release').on('click',$.proxy(this.selectReleasePackages,this));$('select.package-select').on('change',$.proxy(this.updatePackageDropdownOnChange,this));QueueView.subscribe('queue-item-changed',$.proxy(this.queueItemChanged,this));},addVersionMessageBelowPackageSelects:function(){$('.package-select').each(function(i,select){select=$(select);select.attr('data-original-val',select.val());var safeID=select.attr('id').replace('pckg_select_','').replace('.','\\.');$('#pckg_select_msg_'+safeID).html('Current version <strong>'+select.val()+'</strong>.');});},selectReleasePackages:function(event){var target=$(event.target);this.makeReleaseLinkActive(target);var releaseDate=target.attr('data-date');var release=this.findReleaseByDate(releaseDate);for(i=0;i<release.packages.length;i++){var pckg=release.packages[i];var safeID=pckg.name.toLowerCase().replace('.','\\.');this.updatePackageDropdown(safeID,pckg.version);}
target.closest('div.btn-group').removeClass('open');return false;},findReleaseByDate:function(releaseDate){var release;for(var i=0;i<this.releases.length;i++){if(this.releases[i].date==releaseDate){return this.releases[i];}}
return false;},updatePackageDropdownOnChange:function(event){var target=$(event.target);var name=target.attr('id').replace('pckg_select_','');this.updatePackageDropdown(name,target.val());},updatePackageDropdown:function(name,version){var safeID=name.toLowerCase().replace('.','\\.');var select=$('#pckg_select_'+safeID);var message=$('#pckg_select_msg_'+safeID);var originalVal=$.trim(select.attr('data-original-val'));if(originalVal!=version&&originalVal!='undefined'){select.val(version);select.addClass('warning');message.addClass('warning');var html=(version)?'New version <strong>'+version+'</strong>. ':'Packaged will be removed. ';html+='Current version <strong>'+originalVal+'</strong>.';message.html(html);}
else{select.val(version);select.removeClass('warning');message.removeClass('warning');message.html('Current version <strong>'+originalVal+'</strong>.');}},makeReleaseLinkActive:function(el){$('#release-dropdown li').each(function(i,li){$(li).removeClass('active');});el.parent().addClass('active');},bindToDataActions:function(){$('#add-pckg').on('click',function(){$('#add-packages').modal();});$('#cycle').on('click',$.proxy(this.cycle,this));$('.new-version-btn').on('click',$.proxy(this.showPushPackageModal,this));$('#release-service').on('click',$.proxy(this.releaseService,this));},releaseService:function(event){var releaseButton=$(event.target);var packages=this.getActiveReleasePackages();if(this.canRelease(releaseButton,packages)){$('#release-service').popover('hide');this.disableReleaseServiceButton();var params={packages:JSON.stringify(packages)};var url='/sites/'+Data.site_name+'/'+Data.name_url+'/release';var msg='Releasing '+Data.name+' to '+Data.site_name+'. Please be patient and stay awesome.';this.post(url,params,this.doneReleaseService,this.failedReleaseService,msg);}
else{if(releaseButton.hasClass('disabled')){$('#release-service').popover('hide');}
else{setTimeout(function(){$('#release-service').popover('hide');},3500);}}
event.preventDefault();return false;},canRelease:function(releaseButton,packages){if(releaseButton.hasClass('disabled')){return false;}
return this.hasChanges(packages);},hasChanges:function(packages){for(var name in packages){return true;}
return false;},disableReleaseServiceButton:function(){$('#release-service').addClass('disabled');},enableReleaseServiceButton:function(){$('#release-service').removeClass('disabled');},getActiveReleasePackages:function(){var packages={};$('select.package-select').each(function(i,select){select=$(select);var name=select.attr('id').replace('pckg_select_','');var version=select.val();var originalVal=$.trim(select.attr('data-original-val'));if(originalVal!=version&&originalVal!='undefined'){packages[name]=version;}});return packages;},doneReleaseService:function(rslt){this.enableReleaseServiceButton();},failedReleaseService:function(rslt){this.enableReleaseServiceButton();this._showStandardErrorMessage(rslt);},cycle:function(event){if(!$(event.target).hasClass('disabled')){this.disableCycleButton();var url='/sites/'+Data.site_name+'/'+Data.name_url+'/cycle';var msg='Cycling '+Data.name+'. Please be patient and stay awesome.';this.get(url,{},this.doneCycleService,false,msg);}
event.preventDefault();return false;},doneCycleService:function(rslt){},queueItemChanged:function(event,item){if(item.job_type=='cycle_services'){if(item.status=='failed'||item.status=='complete'){this.enableCycleButton();}}
else if(item.job_type=='push_to_cheeseprism'){if(item.status=='complete'){this.updatePackagesDropdown(item.package_name,item.version);}}},disableCycleButton:function(){$('#cycle').addClass('disabled');},enableCycleButton:function(){$('#cycle').removeClass('disabled');},showPushPackageModal:function(event){var name=$(event.srcElement).attr('data-name');var url='/sites/'+Data.site_name+'/';url+=Data.name_url+'/cheese_prism_modal';this.get(url,{'name':name},this.doneShowPushPackageModal);return false;},doneShowPushPackageModal:function(rslt){$('#push-to-cheese-modal').on('shown',function(){ServiceEnv.validateShowPushPackageModal();$('#build_new_package_branch').on('change click',ServiceEnv.validateShowPushPackageModal);$('#build_new_package_version').on('keyup',ServiceEnv.validateShowPushPackageModal).on('mouseup',ServiceEnv.validateShowPushPackageModal);$('#build_new_package').on('click',$.proxy(ServiceEnv.pushPackage,ServiceEnv));});$('#push-to-cheese-modal').html(rslt).modal();},validateShowPushPackageModal:function(){var branch=$.trim($('#build_new_package_branch').val());var version=$.trim($('#build_new_package_version').val());if(branch&&version)$('#build_new_package').removeClass('disabled');else $('#build_new_package').addClass('disabled');var nextFullVersion=(version+'-'+branch).replace(/[\.-]$/,'');$('#next-full-version').html(nextFullVersion);},pushPackage:function(event){if($(event.target).hasClass('disabled'))return false;var url='/sites/'+Data.site_name+'/';url+=Data.name_url+'/cheese_prism_push';var params={'name':$('#build_new_package_name').val(),'branch':$('#build_new_package_branch').val(),'next_version':$('#build_new_package_version').val()};var msg='Pushing package '+params.name+' version '+
params.next_version+'. Please be patient and stay awesome.';this.get(url,params,this.donePushPackage,this.failedPushPackage,msg);return false;},donePushPackage:function(rslt){$('#push-to-cheese-modal').modal('hide');},updatePackagesDropdown:function(package_name,version){$('#pckg_select_'+package_name).append('<option value="'+version+'">'+version+'</option>').val(version).change();},failedPushPackage:function(rslt){$('#release_package_errors').removeClass('hide').html(rslt.html);}};$(document).ready(function(){ServiceEnv.init();});;