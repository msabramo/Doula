_mixin=function(target,source){for(var x in source){target[x]=source[x];}};var DataEventManager={subscribe:function(event,fn){$(this).bind(event,fn);},publish:function(event,data){$(this).trigger(event,data);}};_inArray=function(key,array,attribute){for(var i=0;i<array.length;i++){var item=array[i];if(typeof(item)=='object'){if(key==item[attribute])return item;}
else{if(key==item)return item;}}
return false;};_withoutArray=function(array,key,attribute){var arrayWithout=[];for(var i=0;i<array.length;i++){var item=array[i];if(typeof(item)=='object'){if(array!=item[attribute])arrayWithout.push(item);}
else{if(array!=item)arrayWithout.push(item);}}
return arrayWithout;};var AJAXUtil={post:function(url,params,onDone,onFail,msg){this._send('POST',url,params,onDone,onFail,msg);},get:function(url,params,onDone,onFail,msg){this._send('GET',url,params,onDone,onFail,msg);},_send:function(type,url,params,onDone,onFail,msg){onDone=$.proxy(onDone,this);if(typeof(onFail)=='function')onFail=$.proxy(onFail,this);if(msg)Notifier.info(msg,false);$.ajax({url:url,type:type,data:this._getDataValues(params),error:function(){if(typeof(onFail)=='function'){onFail(rslt);}
else{AJAXUtil._showStandardErrorMessage(rslt);}},success:function(response){try{if(msg){setTimeout(function(){Notifier.hide();},1500);}
rslt=(typeof(response)=='string')?$.parseJSON(response):response;if(rslt.success){onDone(rslt);}
else{if(typeof(onFail)=='function'){onFail(rslt);}
else{Notifier.hide();AJAXUtil._showStandardErrorMessage(rslt);}}}
catch(err){onDone(response);}}});},_getDataValues:function(params){var dataValues='';var count=0;for(var key in params){if(dataValues!=='')dataValues+='&';dataValues+=key+'='+encodeURIComponent(params[key]);}
return dataValues;},_showStandardErrorMessage:function(rslt){$('#modal-error').on('show',function(){$('#modal-error-msg').html(rslt.msg);$('#modal-error-close').on('click',function(){$('#modal-error').modal('hide');return false;});});$('#modal-error').modal();}};;var Data={name:'',last_tag:'',name_url:'',nodes:{},services:{},status:'',token:'',init:function(){this.token=__token;_mixin(this,__site);_mixin(this,AJAXUtil);},tagService:function(service,tag,tag_msg){var url=['/sites',Data.name_url,service.name_url,'tag'].join('/');var params={'tag':tag,'msg':tag_msg};var msg='Tagging service. Please be patient and stay awesome.';this.post(url,params,this.doneTagService,false,msg);},doneTagService:function(rlst){this.services[rlst.service.name_url]=rlst.service;UI.doneTagService(rlst.service);},tagSite:function(tag,tag_msg){var url='/tagsite';var params={'site':Data.name_url,'tag':tag,'msg':tag_msg};var msg='Tagging site. Please be patient and stay awesome.';this.post(url,params,this.donetagSite,this.failedtagSite,msg);},donetagSite:function(rslt){Data.status=rslt.site.status;Data.last_tag=rslt.site.last_tag;UI.doneTagService('site');},failedtagSite:function(){UI.failedTag();},revertServiceTag:function(service,tag,msg){service.tag=tag;service.msg=msg;service.status=service.originalStatus;},findServiceByID:function(name_url){return this.services[name_url];},isReadyForDeploy:function(){var isReadyForDeploy=true;for(var i=0;i<this.services.length;i++){if(this.services[i].status!='deployed'&&this.services[i].status!='tagged'){isReadyForDeploy=false;break;}}
return isReadyForDeploy;}};;var UI={statusClassHash:{'deployed':'deployed','uncommitted_changes':'error','change_to_config':'changed','change_to_app_env':'changed','change_to_app_and_config':'changed','tagged':'tagged'},init:function(){this.showTooltips();$('.collapse').collapse({parent:'#sites-accordion',toggle:false});},showTooltips:function(){$('a[rel="tooltip"]').on('click',function(event,a){if($(event.target).attr('data-toggle')=='do_not_collapse'){return false;}}).tooltip({'placement':'right'});},onTagService:function(elID){$('#form_'+elID+' button').attr('disabled',true).addClass('disabled');},doneTagService:function(service){$('#collapse_'+service.name_url).collapse('hide');$('#link_'+service.name_url+' span').attr('class','status-tagged');$('#link_'+service.name_url).unbind().attr('data-toggle','do_not_collapse').on('click',function(){return false;});},failedTag:function(){$('form button').attr('disabled',false).removeClass('disabled');},getStatusClass:function(app){return'status-'+this.statusClassHash[app.status];},getStatClass:function(app){return'stat-'+this.statusClassHash[app.status];}};;var Site={init:function(){_mixin(this,AJAXUtil);Data.init();UI.init();this.bindToUIActions();this.bindToDataActions();},bindToUIActions:function(){this.initFilter();this.initToolTips();},initToolTips:function(){$('[rel="tooltip"]').tooltip();},filterableEls:$('.filterable'),initFilter:function(){$('#clear')._on('click',this.clearFilter,this);$('#filter')._on('keyup',this.filterServices,this,allowEventToBubble=true);this.initFilterBox();},clearFilter:function(){$('#filter').val('').keyup().focus();},filterServices:function(event,filter){var searchText=$.trim(filter.val().toLowerCase());$.cookie(this.getCookieName(),searchText);var searchArray=searchText.split(',');this.filterableEls.each($.proxy(function(i,el){el=$(el);var filterData=el.data('filter-data').toLowerCase();if(searchText===''){el.show();}
else if(this.inSearchArray(searchArray,filterData)){el.show();}
else{el.hide();}},this));},inSearchArray:function(searchArray,text){for(var i=0;i<searchArray.length;i++){var searchPart=$.trim(searchArray[i]);if(searchPart==='')continue;if(text.indexOf(searchPart)!=-1){return true;}}
return false;},initFilterBox:function(){var searchText=$.cookie(this.getCookieName());$('#filter').val(searchText).keyup().focus();},getCookieName:function(){return'serviceFilter.'+Data.name;},bindToDataActions:function(){$('input.tag').on('change',this.validateTag);$('textarea.commit').on('change',this.validateMsg);$('a.deploy').on('click',this.deployService);$('#lock-site').on('click',$.proxy(this.toggleSiteLock,this));},tag:function(event){var serviceID=this.id.replace('form_','');if(serviceID=='site')Site.tagSite(serviceID);else Site.tagService(serviceID);return false;},tagSite:function(){var tag=$('#tag_site').val();var msg=$('#msg_site').val();UI.onTag();Data.tagSite(tag,msg);},tagService:function(serviceID){var service=Data.findServiceByID(serviceID);var tag=$('#tag_'+service.name_url).val();var msg=$('#msg_'+service.name_url).val();UI.onTagService(service.name_url);Data.tagService(service,tag,msg);},validateTag:function(event){if(!this.value){var service=Data.findServiceByID(this.id.replace('tag_',''));Data.revertServiceTag(service,'',service.msg);UI.tagService(service);}},validateMsg:function(){if(!this.value){var service=Data.findServiceByID(this.id.replace('msg_',''));Data.revertServiceTag(service,service.tag,'');UI.tagService(service);}},toggleSiteLock:function(event){var lockButton=$(event.target);if(!lockButton.hasClass('disabled')){var params={'lock':'true'};var msg='Locking site. Please be patient and stay awesome.';if(lockButton.hasClass('locked')){params={'lock':'false'};msg='Unlocking site. Please be patient and stay awesome.';}
var url='/sites/'+Data.name_url+'/lock';this.post(url,params,this.doneToggleSiteLock,false,msg);}
return false;},doneToggleSiteLock:function(rslt){var lockButton=$('#lock-site');if(lockButton.hasClass('locked')){lockButton.removeClass('locked').addClass('unlocked').html('<i class="icon-lock icon-black"></i> Lock Site');}
else{lockButton.removeClass('unlocked').addClass('locked').html('<i class="icon-lock icon-black"></i> Unlock Site');}}};$(document).ready(function(){Site.init();});;var ServiceLabel={originalLabelWidths:{},DEFAULT_LABEL_LENGTH:20,CHAR_MULTIPLIER:6,init:function(){_mixin(this,AJAXUtil);$('a.edit-label')._on('click',this.handleLabelEdit,this);$('span.accord-title-label input')._on('blur',this.handleLabelLostFocus,this);$('span.accord-title-label input')._on('keydown',this.handleLabelKeydown,this,true);},handleLabelEdit:function(event,link){var serviceName=link.data("service");var link=$("#label-for-"+serviceName);link.addClass('hidden');var input=$("#input-label-for-"+serviceName);this.resizeLabelInput(input);input.addClass('active').focus();},handleLabelLostFocus:function(event,input){this.handleLabelSave(input);},handleLabelKeydown:function(event,input){if(event.keyCode==13){this.handleLabelSave(input);}
this.resizeLabelInput(input);},handleLabelSave:function(input){input.removeClass('active');var siteName=input.data("site");var serviceName=input.data("service");var label=$("#label-for-"+serviceName);var text=$.trim(input.val());label.html(text).removeClass('hidden');var url='/sites/'+siteName+'/'+serviceName+'/label';var params={'label':text};var msg='Saving label. Please be patient and stay awesome.';this.post(url,params,this.doneHandleLabelSave,null,msg);},doneHandleLabelSave:function(rslt){},resizeLabelInput:function(input){var text=input.val();if(!this.originalLabelWidths[input.attr('id')]){this.originalLabelWidths[input.attr('id')]=input.width();}
if(text.length>this.DEFAULT_LABEL_LENGTH){var moreChars=text.length-this.DEFAULT_LABEL_LENGTH;input.css('width',this.originalLabelWidths[input.attr('id')]+(moreChars*this.CHAR_MULTIPLIER));}}};$(document).ready(function(){ServiceLabel.init();});;