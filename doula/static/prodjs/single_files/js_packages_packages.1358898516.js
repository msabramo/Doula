var Packages={siteName:'',serviceName:'',init:function(){_mixin(this,AJAXUtil);this.bindToBuildNewPackageButtons();},initPackagesAsMixin:function(siteName,serviceName){this.siteName=siteName;this.serviceName=serviceName;this.bindToBuildNewPackageButtons();},bindToBuildNewPackageButtons:function(){$('.new-version-btn')._on('click',this.showBuildNewPackageModal,this);QueueView.subscribe('queue-item-changed',$.proxy(this.queuePackageJobChanged,this));},showBuildNewPackageModal:function(event,button){var name=button.data('name');var url='/packages/build_new_package_modal';this.get(url,{'name':name},this.doneShowBuildNewPackageModal);},doneShowBuildNewPackageModal:function(rslt){$('#build-new-package-modal').on('shown',$.proxy(function(){this.validateShowBuildNewPackageModal();$('#build_new_package_branch').on('change click',this.validateShowBuildNewPackageModal);$('#build_new_package_version').on('keyup',this.validateShowBuildNewPackageModal).on('mouseup',this.validateShowBuildNewPackageModal);$('#build_new_package')._on('click',this.buildNewPackage,this);},this));$('#build-new-package-modal').html(rslt).removeClass('hide').modal();},validateShowBuildNewPackageModal:function(){var branch=$.trim($('#build_new_package_branch').val());var version=$.trim($('#build_new_package_version').val());if(branch&&version)$('#build_new_package').removeClass('disabled');else $('#build_new_package').addClass('disabled');var nextFullVersion=(version+'-'+branch).replace(/[\.-]$/,'');$('#next-full-version').html(nextFullVersion);},buildNewPackage:function(event,button){if(!button.hasClass('disabled')){var url='/packages/build_new_package';var params={'site_name':this.siteName,'service_name':this.serviceName,'name':$('#build_new_package_name').val(),'branch':$('#build_new_package_branch').val(),'next_version':$('#build_new_package_version').val()};var msg='Pushing package '+params.name+' version '+
params.next_version+'. Please be patient and stay awesome.';this.get(url,params,this.doneBuildNewPackage,this.failedBuildNewPackage,msg);}},doneBuildNewPackage:function(rslt){$('#build-new-package-modal').modal('hide');if(ServiceEnv)ServiceEnv.showDashboardDetailView();},failedBuildNewPackage:function(rslt){$('#build_package_errors').removeClass('hide').html(rslt.html);},queuePackageJobChanged:function(event,job){if(job.job_type=='build_new_package'){if(job.status=='complete'){this.updatePackagesDropdown(job);if(ServiceEnv)ServiceEnv.showDashboardDetailView();}}},updatePackagesDropdown:function(job){$('#pckg_select_'+job.comparable_name).prepend('<option value="'+job.version+'">'+job.version+'</option>').val(job.version).change();}};$(document).ready(function(){if(document.location.href.match(/\/packages/)){Packages.init();}});