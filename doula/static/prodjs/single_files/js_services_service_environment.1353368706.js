var ServiceEnv={init:function(){this.releases=__releases;this.other_packages=__other_packages;_mixin(this,AJAXUtil);_mixin(this,Packages);Data.init();this.bindToUIActions();this.bindToDataActions();this.initPackagesAsMixin(Data.site_name,Data.name_url);},bindToUIActions:function(){$('a[rel="tooltip"]').tooltip({"delay":{"show":500,"hide":100}});$(".hide-on-load").each(function(index,el){$(el).show();});$('.commit-accordion').on('show',function(){$(this).parent().removeClass('hidden').addClass('shown');});$('.commit-accordion').on('hide',function(){$(this).parent().removeClass('shown').addClass('hidden');});this.addVersionMessageBelowPackageSelects();$('a.release').on('click',$.proxy(this.selectReleasePackages,this));$('select.package-select').on('change',$.proxy(this.updatePackageDropdownOnChange,this));$('#pckg_select_add_new_package').on('change',$.proxy(this.updateAddNewPackageVersions,this));$('#pckg_select_add_new_package, #pckg_select_add_new_package_version').on('change',$.proxy(this.updateAddNewPackageVersionsMessage,this));QueueView.subscribe('queue-item-changed',$.proxy(this.queueServiceJobChanged,this));this.bindToMiniDashboardActions();},firstRun:true,miniDashboardDetails:$('.mini-dashboard-details'),miniDashboardDetailElements:$('.mini-dashboard-detail'),bindToMiniDashboardActions:function(){if(this.firstRun){this.firstRun=false;this.miniDashboardDetails.slideUp('fast');this.miniDashboardDetailElements.addClass('hide');}
$('.mini-dashboard-square').unbind();$('.mini-dashboard-square').on('click',$.proxy(function(event){var targetDetail=$($(event.target).closest('div.mini-dashboard-square').data('target'));if(targetDetail.is(":visible")){this.miniDashboardDetails.slideUp('fast');this.miniDashboardDetailElements.addClass('hide');}
else if(this.miniDashboardDetails.is(":visible")){this.miniDashboardDetailElements.addClass('hide');targetDetail.removeClass('hide');}
else if(!this.miniDashboardDetails.is(":visible")){this.miniDashboardDetailElements.addClass('hide');targetDetail.removeClass('hide');this.miniDashboardDetails.slideDown('fast');}},this));},showDashboardDetailView:function(){this.miniDashboardDetailElements.addClass('hide');$('#mini-dashboard-detail-jobs').removeClass('hide');this.miniDashboardDetails.slideDown('fast');},updateMiniDashboard:function(){var url='/sites/'+Data.site_name+'/'+Data.name_url+'/dash';this.get(url,{},this.doneUpdateMiniDashboard,false,msg=false);},doneUpdateMiniDashboard:function(rslt){$('#mini-dashboard-squares').replaceWith(rslt.squaresHTML);$('#mini-dashboard-detail-config').replaceWith(rslt.configHTML);$('#mini-dashboard-detail-releases').replaceWith(rslt.releasesHTML);this.miniDashboardDetails=$('.mini-dashboard-details');this.miniDashboardDetailElements=$('.mini-dashboard-detail');this.bindToMiniDashboardActions();},addVersionMessageBelowPackageSelects:function(){$('.package-select').each(function(i,select){select=$(select);select.attr('data-original-val',select.val());var packageName=select.data('comparable-name');$('#pckg_select_msg_'+packageName).html('Current version <strong>'+select.val()+'</strong>.');});},selectReleasePackages:function(event){var target=$(event.target);this.makeReleaseLinkActive(target);var releaseDate=target.attr('data-date');var release=this.findReleaseByDate(releaseDate);for(i=0;i<release.packages.length;i++){var pckg=release.packages[i];this.updatePackageDropdown(pckg.comparable_name,pckg.version);}
target.closest('div.btn-group').removeClass('open');return false;},findReleaseByDate:function(releaseDate){var release;for(var i=0;i<this.releases.length;i++){if(this.releases[i].date==releaseDate){return this.releases[i];}}
return false;},updatePackageDropdownOnChange:function(event){var selectEl=$(event.target);var name=selectEl.data('comparable-name');var value=selectEl.val();this.updatePackageDropdown(name,value);},updatePackageDropdown:function(name,version){var select=$('#pckg_select_'+name);var message=$('#pckg_select_msg_'+name);var originalVal=$.trim(select.attr('data-original-val'));if(originalVal!=version&&originalVal!='undefined'){select.val(version);select.addClass('warning');message.addClass('warning');var html=(version)?'New version <strong>'+version+'</strong>. ':'Packaged will be removed. ';html+='Current version <strong>'+originalVal+'</strong>.';message.html(html);}
else{select.val(version);select.removeClass('warning');message.removeClass('warning');message.html('Current version <strong>'+originalVal+'</strong>.');}},makeReleaseLinkActive:function(el){$('#release-dropdown li').each(function(i,li){$(li).removeClass('active');});el.parent().addClass('active');},updateAddNewPackageVersions:function(){var value=$('#pckg_select_add_new_package').val();if(value){var options="<option value=\"\">Select a Version</option>";var versions=this.other_packages[value].versions;for(var i=0;i<versions.length;i++){options+="<option value=\""+versions[i]+"\">";options+=versions[i]+"</option>";}
$('#pckg_select_add_new_package_version').html(options);}},updateAddNewPackageVersionsMessage:function(){var packageName=$('#pckg_select_add_new_package').val();var version=$('#pckg_select_add_new_package_version').val();var msg='';if(packageName&&version){var name=this.other_packages[packageName].name;var msg='Adding package <strong>'+name+'</strong> ';msg+='version <strong>'+version+'</strong>.';}
$('#pckg_select_add_new_package_msg').html(msg);},bindToDataActions:function(){$('#cycle').on('click',$.proxy(this.cycle,this));$('#release-service').on('click',$.proxy(this.releaseService,this));},releaseService:function(event){this.disableReleaseServiceButton();var params={packages:JSON.stringify(this.getActiveReleasePackages())};var url='/sites/'+Data.site_name+'/'+Data.name_url+'/release';var msg='Releasing '+Data.name+' to '+Data.site_name+'. Please be patient and stay awesome.';this.post(url,params,this.doneReleaseService,this.failedReleaseService,msg);event.preventDefault();return false;},getActiveReleasePackages:function(){var packages={};$('select.package-select').each(function(i,select){select=$(select);var name=select.data('name');var version=select.val();var originalVal=$.trim(select.attr('data-original-val'));if(originalVal!=version&&originalVal!='undefined'){packages[name]=version;}});var packageName=$('#pckg_select_add_new_package').val();var version=$('#pckg_select_add_new_package_version').val();if(packageName&&version){packages[this.other_packages[packageName].name]=version;}
return packages;},doneReleaseService:function(rslt){this.showDashboardDetailView();this.enableReleaseServiceButton();},failedReleaseService:function(rslt){this.enableReleaseServiceButton();this._showStandardErrorMessage(rslt);},disableReleaseServiceButton:function(){$('#release-service').addClass('disabled');},enableReleaseServiceButton:function(){$('#release-service').removeClass('disabled');},updateServicePackagesAfterRelease:function(job){for(var comparable_name in job.comparable_packages){var select=$('#pckg_select_'+comparable_name);var version=job.comparable_packages[comparable_name];select.attr('data-original-val',version);select.change();Data.packages[comparable_name]['version']=version;}},cycle:function(event){if(!$(event.target).hasClass('disabled')){this.disableCycleButton();var url='/sites/'+Data.site_name+'/'+Data.name_url+'/cycle';var msg='Cycling '+Data.name+'. Please be patient and stay awesome.';this.get(url,{},this.doneCycleService,false,msg);}
event.preventDefault();return false;},doneCycleService:function(rslt){this.showDashboardDetailView();},disableCycleButton:function(){$('#cycle').addClass('disabled');},enableCycleButton:function(){$('#cycle').removeClass('disabled');},queueServiceJobChanged:function(event,job){if(job.job_type=='cycle_service'){if(job.status=='failed'||job.status=='complete'){this.enableCycleButton();this.updateMiniDashboard();}}
else if(job.job_type=='release_service'){if(job.status=='failed'||job.status=='complete'){this.updateMiniDashboard();}
if(job.status=='complete'){this.updateServicePackagesAfterRelease(job);}}}};$(document).ready(function(){ServiceEnv.init();});