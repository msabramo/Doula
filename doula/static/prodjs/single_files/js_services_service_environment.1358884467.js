var ServiceEnv={init:function(){this.releases=__releases;this.other_packages=__other_packages;this.latest_service_config=__latest_service_config;this.service=__service;_mixin(this,AJAXUtil);_mixin(this,Packages);Data.init();this.bindToUIActions();this.bindToDataActions();this.initPackagesAsMixin(Data.site_name,Data.name_url);},bindToUIActions:function(){this.initToolTips();this.showElementsHiddenOnLoad();this.addVersionMessageBelowPackageSelects();this.bindToReleasesAndPackages();this.bindToServiceConfigChanges();this.bindToAddPythonPackageSelects();QueueView.subscribe('queue-item-changed',$.proxy(this.queueServiceJobChanged,this));this.bindToMiniDashboardActions();},initToolTips:function(){$('a[rel="tooltip"]').tooltip({"delay":{"show":500,"hide":100}});},showElementsHiddenOnLoad:function(){$(".hide-on-load").each(function(index,el){$(el).show();});$('.commit-accordion').on('show',function(){$(this).parent().removeClass('hidden').addClass('shown');});$('.commit-accordion').on('hide',function(){$(this).parent().removeClass('shown').addClass('hidden');});},bindToServiceConfigChanges:function(){$('#config_sha').on('change blur',$.proxy(this.updateServiceConfigMessage,this));$('#config_sha').val(this.latest_service_config.sha).change();},bindToReleasesAndPackages:function(){$('#release-service-locked')._on('click',function(){});$('a.release')._on('click',this.selectReleaseConfigAndPackages,this);$('select.package-select').on('change',$.proxy(this.updatePackageDropdownOnChange,this));},bindToAddPythonPackageSelects:function(){$('#pckg_select_add_new_package')._on('change',this.updateAddNewPackageVersions,this,allowEventToBubble=true);var addNewPackageSelects=$('#pckg_select_add_new_package, #pckg_select_add_new_package_version');addNewPackageSelects._on('change',this.updateAddNewPackageVersionsMessage,this);addNewPackageSelects._on('change',this.updateAfterSelectAddNewPackageVersion,this);},firstRun:true,miniDashboardDetails:$('.mini-dashboard-details'),miniDashboardDetailElements:$('.mini-dashboard-detail'),bindToMiniDashboardActions:function(){if(this.firstRun){this.firstRun=false;this.miniDashboardDetails.slideUp('fast');this.miniDashboardDetailElements.addClass('hide');}
$('.mini-dashboard-square').unbind();$('.mini-dashboard-square').on('click',$.proxy(function(event){var targetDetail=$($(event.target).closest('div.mini-dashboard-square').data('target'));if(targetDetail.is(":visible")){this.miniDashboardDetails.slideUp('fast');this.miniDashboardDetailElements.addClass('hide');}
else if(this.miniDashboardDetails.is(":visible")){this.miniDashboardDetailElements.addClass('hide');targetDetail.removeClass('hide');}
else if(!this.miniDashboardDetails.is(":visible")){this.miniDashboardDetailElements.addClass('hide');targetDetail.removeClass('hide');this.miniDashboardDetails.slideDown('fast');}},this));},showDashboardDetailView:function(viewType){viewType=viewType||'jobs';this.miniDashboardDetailElements.addClass('hide');$('#mini-dashboard-detail-'+viewType).removeClass('hide');this.miniDashboardDetails.slideDown('fast');},updateMiniDashboard:function(){var url='/sites/'+Data.site_name+'/'+Data.name_url+'/dash';this.get(url,{},this.doneUpdateMiniDashboard,false,msg=false);},doneUpdateMiniDashboard:function(rslt){$('#mini-dashboard-squares').replaceWith(rslt.squaresHTML);$('#mini-dashboard-detail-config').replaceWith(rslt.configHTML);$('#mini-dashboard-detail-releases').replaceWith(rslt.releasesHTML);this.miniDashboardDetails=$('.mini-dashboard-details');this.miniDashboardDetailElements=$('.mini-dashboard-detail');this.bindToMiniDashboardActions();},updateServiceConfigMessage:function(event){var activeSha=$('#config_sha').val();var sc=this.findServiceConfigBySha(activeSha);var ac=this.service.config;var lc=this.latest_service_config;var warnClass=(sc.sha==ac.sha&&sc.sha==lc.sha)?'':'warning';$('#config_sha').removeClass('warning').addClass(warnClass);var warnHTML=this.buildServiceConfigWarnHTML(sc,ac,lc);$('#config_sha_warning').html(warnHTML).removeClass('warning').addClass(warnClass);var html=this.buildServiceConfigColHTML(sc);$('#service_config_col').html(html).removeClass('warning').addClass(warnClass);},buildServiceConfigColHTML:function(sc){var html="<a href=\"http://code.corp.surveymonkey.com/config/";html+=sc.service+"/tree/"+sc.sha+"\" target=\"_blank\">";html+=sc.message+"</a>";return html;},buildServiceConfigWarnHTML:function(sc,ac,lc){var html="";if(sc.sha==ac.sha&&sc.sha==lc.sha){html="The selected config from <strong>"+sc.formatted_date+"</strong> is the latest and active version.";}
else if(sc.sha!=ac.sha&&sc.sha==lc.sha){html="The selected and latest config from <strong>"+sc.formatted_date+"</strong> is <strong>NOT</strong> the active config. <br /><br />";html+="The active config is from <strong>"+ac.formatted_date+"</strong>.";}
else if(sc.sha==ac.sha&&sc.sha!=lc.sha){html="The selected and active config from <strong>"+sc.formatted_date+"</strong> is <strong>NOT</strong> the latest version. <br /><br />";html+="The latest config is from <strong>"+lc.formatted_date+"</strong>.";}
else if(sc.sha!=ac.sha&&sc.sha!=lc.sha){html="The selected config from <strong>"+sc.formatted_date+"</strong> is <strong>NOT</strong> the latest version. <br /><br />";html+="The latest config is from <strong>"+lc.formatted_date+"</strong>.";}
return html;},findServiceConfigBySha:function(sha){for(var i=0;i<__service_configs.length;i++){if(__service_configs[i].sha==sha)return __service_configs[i];}
return{};},isConfigUpToDate:function(){return(this.latest_service_config.sha==this.service.config.sha);},addVersionMessageBelowPackageSelects:function(){$('.package-select').each(function(i,select){select=$(select);select.attr('data-original-val',select.val());var packageName=select.data('comparable-name');$('#pckg_select_msg_'+packageName).html('Current version <strong>'+select.val()+'</strong>.');});},selectReleaseConfigAndPackages:function(event,dropdownLink){this.seleectReleaseConfig(dropdownLink);this.selectReleasePackageFromDropdown(dropdownLink);this.showDiffForRelease(dropdownLink);},seleectReleaseConfig:function(dropdownLink){var releaseDate=dropdownLink.attr('data-date');var release=this.findReleaseByDate(releaseDate);$('#config_sha').val(release.sha1_etc).change();},showDiffForRelease:function(dropdownLink){var params=this.getDiffForReleaseParams(dropdownLink);var url='/sites/'+Data.site_name+'/'+Data.name_url+'/diff';var msg='Pulling release diff. Please be patient and stay awesome.';this.post(url,params,this.doneShowDiffForRelease,null,msg);},getDiffForReleaseParams:function(dropdownLink){var date='';if(typeof(dropdownLink)!='undefined'){date=dropdownLink.data('date');};return{date:date,sha:$('#config_sha').val(),packages:JSON.stringify(this.getActiveReleasePackages(true))};},doneShowDiffForRelease:function(rslt){this.doneUpdateMiniDashboard(rslt);if(rslt.diff.diff_exists){this.showDashboardDetailView('releases');}},selectReleasePackageFromDropdown:function(dropdownLink){this.makeReleaseLinkActive(dropdownLink);var releaseDate=dropdownLink.attr('data-date');var release=this.findReleaseByDate(releaseDate);if(release){for(i=0;i<release.packages.length;i++){var pckg=release.packages[i];this.updatePackageDropdown(pckg.comparable_name,pckg.version);}}
dropdownLink.closest('div.btn-group').removeClass('open');},findReleaseByDate:function(releaseDate){var release;for(var i=0;i<this.releases.length;i++){if(this.releases[i].date==releaseDate){return this.releases[i];}}
return false;},updatePackageDropdownOnChange:function(event){var selectEl=$(event.target);var name=selectEl.data('comparable-name');var value=selectEl.val();this.updatePackageDropdown(name,value);this.showDiffForRelease();},updatePackageDropdown:function(name,version){if(this.selectHasValue(name,version)){var select=$('#pckg_select_'+name);select.val(version);var message=$('#pckg_select_msg_'+name);var originalVal=$.trim(select.attr('data-original-val'));if(originalVal!=version&&originalVal!='undefined'){select.addClass('warning');message.addClass('warning');var html=(version)?'New version <strong>'+version+'</strong>. ':'Packaged will be removed. ';html+='Current version <strong>'+originalVal+'</strong>.';message.html(html);}
else{select.removeClass('warning');message.removeClass('warning');message.html('Current version <strong>'+originalVal+'</strong>.');}}},selectHasValue:function(name,value){return $("#pckg_select_"+name+" option[value='"+value+"']").length!==0;},makeReleaseLinkActive:function(el){$('#release-dropdown li').each(function(i,li){$(li).removeClass('active');});el.closest('li').addClass('active');},updateAddNewPackageVersions:function(){var value=$('#pckg_select_add_new_package').val();if(value){var options="<option value=\"\">Select a Version</option>";var versions=this.other_packages[value].versions;for(var i=0;i<versions.length;i++){options+="<option value=\""+versions[i]+"\">";options+=versions[i]+"</option>";}
$('#pckg_select_add_new_package_version').html(options);}},updateAfterSelectAddNewPackageVersion:function(){this.showDiffForRelease();},updateAddNewPackageVersionsMessage:function(){var packageName=$('#pckg_select_add_new_package').val();var version=$('#pckg_select_add_new_package_version').val();var msg='';if(packageName&&version){var name=this.other_packages[packageName].name;msg='New version <strong>'+name+version+'</strong>. No current version exists.';}
$('#pckg_select_add_new_package_msg').html(msg);},bindToDataActions:function(){$('#cycle')._on('click',this.cycle,this);$('#release-service')._on('click',this.releaseService,this);},releaseService:function(event){if(!$('#release-service').prop('disabled')){this.disableReleaseServiceButton();var params={sha:$('#config_sha').val(),packages:JSON.stringify(this.getActiveReleasePackages())};var url='/sites/'+Data.site_name+'/'+Data.name_url+'/release';var msg='Releasing '+Data.name+' to '+Data.site_name+'. Please be patient and stay awesome.';this.post(url,params,this.doneReleaseService,this.failedReleaseService,msg);}},getActiveReleasePackages:function(returnAllPackages){var packages={};returnAllPackages=returnAllPackages||false;$('select.package-select').each(function(i,select){select=$(select);var name=select.data('name');var version=select.val();var originalVal=$.trim(select.attr('data-original-val'));if((originalVal!=version&&typeof(name)!='undefined')||(returnAllPackages&&typeof(name)!='undefined')){packages[name]=version;}});var packageName=$('#pckg_select_add_new_package').val();var version=$('#pckg_select_add_new_package_version').val();if(packageName&&version){packages[this.other_packages[packageName].name]=version;}
return packages;},doneReleaseService:function(rslt){this.showDashboardDetailView();this.enableReleaseServiceButton();},failedReleaseService:function(rslt){this.enableReleaseServiceButton();this._showStandardErrorMessage(rslt);},disableReleaseServiceButton:function(){$('#release-service').prop('disabled',true).addClass('disabled');},enableReleaseServiceButton:function(){setTimeout(function(){$('#release-service').prop('disabled',false).removeClass('disabled');},4000);},updateServiceAfterRelease:function(job){this.service.config.sha=job.manifest.sha1_etc;this.updateServiceConfigMessage();this.updateServicePackagesAfterRelease(job);this.updateMiniDashboard();},updateServicePackagesAfterRelease:function(job){for(var comparable_name in job.manifest.comparable_packages){var select=$('#pckg_select_'+comparable_name);var version=job.manifest.comparable_packages[comparable_name];select.attr('data-original-val',version);select.change();Data.packages[comparable_name]['version']=version;}},cycle:function(event,button){if(!button.hasClass('disabled')){this.disableCycleButton();var url='/sites/'+Data.site_name+'/'+Data.name_url+'/cycle';var msg='Cycling '+Data.name+'. Please be patient and stay awesome.';this.get(url,{},this.doneCycleService,false,msg);}},doneCycleService:function(rslt){this.showDashboardDetailView();},disableCycleButton:function(){$('#cycle').addClass('disabled');},enableCycleButton:function(){$('#cycle').removeClass('disabled');},queueServiceJobChanged:function(event,job){if(job.job_type=='cycle_service'){if(job.status=='failed'||job.status=='complete'){this.enableCycleButton();this.updateMiniDashboard();}}
else if(job.job_type=='release_service'){if(job.status=='failed'||job.status=='complete'){this.updateMiniDashboard();}
if(job.status=='complete'){this.updateServiceAfterRelease(job);}}}};$(document).ready(function(){ServiceEnv.init();});