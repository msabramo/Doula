{% extends 'layouts/base.html' %}
{% import 'queue/queued_item.html' as queued_item_tmpl %}

{% block content %}
<div class="title-bar clearfix">
	<h2>
    <a href="/sites">Sites</a> /
    <a href="/sites/{{site.name_url}}">{{ site.name }}</a> /
    {{ service.name }}
  </h2>
  <ul>
    <li>
      <a id="cycle" class="btn sm-btn" href="#" style="float: left;">
        <i class="icon-repeat icon-black"></i>
        Cycle
      </a>
    </li>
    <li>
      <div class="btn-group {% if config.get('env') == 'prod' %}hide2{% endif %}"
      style="display: inline; float: right;">
        <a id="release-service" href="#"
        class="{% if config.get('env') == 'prod' %}hide2{% endif %} btn sm-btn">
          <i class="icon-arrow-up icon-black"></i> Release Service
        </a>
        <a class="btn sm-btn dropdown-toggle"
        data-toggle="dropdown" href="#">
          <span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
            {% for release in service.get_releases() %}
              <li>
                <a class="release" data-date="{{release.date}}" href="#">
                Pushed {{release.date|relative_datetime}}
                </a>
              </li>
            {% endfor %}
        </ul>
      </div>

    </li>
  </ul>
</div>

<div class="queued_items" data-last-updated="{{ last_updated }}">
  <div class="latest_notifications alert">
  </div>
  {% for queued_item in queued_items %}
    {{ queued_item_tmpl.render_queued_item(queued_item) }}
  {% endfor %}
</div>

<div>

<!-- service_queue_status.html here -->
<div class="accordion group" id="package-accordion">
  <div class="accordion-group">
    <div class="accordion-heading group sm-accordion-title">
      <a href="#" onclick="return false;" data-toggle="collapse"
      data-target="#sm_packages_table">
        Survey Monkey Packages
      </a>
    </div>
  </div>

  <div id="sm_packages_table" class="accordion-body in collapse">
  <table class="table">
    <thead>
      <tr>
        <th>Package</th>
        <th>Version</th>
        <th> &nbsp;</th>
      </tr>
    </thead>
    <tbody>
      <!-- our packages first, the ones with the github repo data -->
      {% for pckg in service.packages|sort(attribute='name') %}
      {% set git_info = pckg.get_github_info() %}

      {% if git_info %}
      <tr>
        <td width="20%">
          <!-- alextodo, add a tooltip to this thing a ma bobber -->
          <a href="#" onclick="return false;" rel="tooltip"
          title="Click to see the Git commit history"
          data-toggle="collapse" data-target="#{{ pckg.name|replace(".", "") }}_git_info">
          {{ pckg.name }}
        </a>
        </td>
        <td width="80%">
          <select id="pckg_select_{{ pckg.name }}">
            {% for version in pckg.get_versions()|sort(reverse=True, case_sensitive=False) %}
              <option value="{{ version }}"
              {% if pckg.version == version %}selected="selected"{% endif %} >
                {{ version }}
              </option>
            {% endfor %}
          </select>
          <a class="btn sm-btn-success new-version-btn" data-name="{{pckg.name}}" href="#">
            <i class="icon-chevron-right icon-white"></i> Release New Version
          </a>
        </td>
      </tr>
      <tr class="git-info-row">
          <!--
            alextodo, after click add class show, remove hidden
            show the commit log right here.
          -->
          <td colspan="2" class="hidden">
            <div id="{{ pckg.name|replace(".", "") }}_git_info"
            class="commit-accordion accordion-body collapse hide-on-load"
            style="display: none;">
              {% include 'services/commits.html' %}
            </div>
          </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
  </div>
  <!-- end sm_packages_table -->

  <div class="accordion-group">
    <div class="accordion-heading group sm-accordion-title">
      <a href="#" onclick="return false;" data-toggle="collapse"
      data-target="#other_packages_table">
        Other packages</a>
    </div>
  </div>

  <div id="other_packages_table" class="accordion-body collapse hide-on-load"
  style="display: none;">
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Package</th>
        <th>Version</th>
      </tr>
    </thead>
    <tbody>
      {% for pckg in service.packages|sort(attribute='name') %}
      {% if not pckg.get_github_info() %}
      <tr>
        <td width="20%">{{ pckg.name }}</td>
        <td width="80%">
          <select id="pckg_select_{{ pckg.name }}">
            {% for version in pckg.get_versions()|sort(reverse=True, case_sensitive=False) %}
              <option value="{{ version }}"
              {% if pckg.version == version %}selected="selected"{% endif %} >
                {{ version }}
              </option>
            {% endfor %}
          </select>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
  </div>
</div>
</div>
<!-- end package-accordion -->

<!-- all the packages on cheese prism not in this service -->
<div id="add-packages" class="modal hide">
  <!-- fill in -->
</div>
<div id="push-to-cheese-modal" class="modal hide">
  <!-- fill in -->
</div>
{% endblock %}

{% block scripts %}
<script>
var __service = {{service_json|safe}};
var __releases = {{releases_json|safe}};
var __job_dict = {{job_dict|safe}};
</script>
{{ [
'/js/common/util.js',
'/js/common/queue.js',
'/js/services/serv_data.js',
'/js/services/serv_env.js'
]|js_script|safe }}
{% endblock %}