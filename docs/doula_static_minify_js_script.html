<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>js_script.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<!-- fly bar -->
<div id="flybar">
<a id="nav-logo" href="index.html">Doula Documentation</a>

<div class="flybar-language">
  <div class="dropdown">
    <a id="pages-dropdown" class="flybar-button">Files
      <b class="caret"></b>
    </a>
    <ul class="dropdown-menu">
      <li><a href="doula___init__.html">doula/__init__.py</a></li>
      <li><a href="doula_cache.html">doula/cache.py</a></li>
      <li><a href="doula_helper_filters.html">doula/helper_filters.py</a></li>
      <li><a href="doula_models_audit.html">doula/models/audit.py</a></li>
      <li><a href="doula_models_site_tag_history.html">doula/models/site_tag_history.py</a></li>
      <li><a href="doula_models_sites.html">doula/models/sites.py</a></li>
      <li><a href="doula_models_sites_dal.html">doula/models/sites_dal.py</a></li>
      <li><a href="doula_static_minify_js_script.html">doula/static/minify/js_script.py</a></li>
      <li><a href="doula_static_minify_jsmin.html">doula/static/minify/jsmin.py</a></li>
      <li><a href="doula_tests_test_audit.html">doula/tests/test_audit.py</a></li>
      <li><a href="doula_tests_test_helper_filters.html">doula/tests/test_helper_filters.py</a></li>
      <li><a href="doula_tests_test_sites.html">doula/tests/test_sites.py</a></li>
      <li><a href="doula_tests_test_sites_dal.html">doula/tests/test_sites_dal.py</a></li>
      <li><a href="doula_tests_test_sites_dao.html">doula/tests/test_sites_dao.py</a></li>
      <li><a href="doula_tests_tests.html">doula/tests/tests.py</a></li>
      <li><a href="doula_util.html">doula/util.py</a></li>
      <li><a href="doula_views.html">doula/views.py</a></li>
      <li><a href="fabfile.html">fabfile.py</a></li>
      <li><a href="setup.html">setup.py</a></li>
      <li><a href="setup_initial.html">setup/initial.py</a></li>
    </ul>
  </div>
</div>
</div>
<!-- end of fly bar -->

<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>js_script.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">environmentfilter</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">contextfilter</span>
<span class="kn">from</span> <span class="nn">jsmin</span> <span class="kn">import</span> <span class="n">jsmin</span>
<span class="kn">from</span> <span class="nn">pyramid</span> <span class="kn">import</span> <span class="n">threadlocal</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>

<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">VERSION_FILE</span> <span class="o">=</span> <span class="s">&#39;version.txt&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Template files to search in project</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">TPL_FILE_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.htm&#39;</span><span class="p">,</span> <span class="s">&#39;.html&#39;</span><span class="p">,</span> <span class="s">&#39;.jinja2&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>also for optimization, if you have jquery already minified, then you don't have to 
minify it, once this is used
for survey monkey be able to pull from something else
todo, take a look at putting a common file list into a special combine list
the COM_LIB_LIST files would always go into they're own file and served as a single
resource. That list of files would always come down as a whole. So even if you don't
list a specific lib file, you'll still get it to ensure we don't have to recompile</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">COM_LIB_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;jquery.js&#39;</span><span class="p">,</span> <span class="s">&#39;jquery.cookie.js&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>The cStringIO class used for speed and memory efficiency
see http://www.skymind.com/~ocrow/python_string/</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Handles creating the script tags for development.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">js_script_dev</span><span class="p">(</span><span class="n">js_files</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">script_tags</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    
    <span class="k">for</span> <span class="n">js_file</span> <span class="ow">in</span> <span class="n">js_files</span><span class="p">:</span>
        <span class="n">script_tags</span> <span class="o">+=</span> <span class="s">&#39;&lt;script type=&quot;text/javascript&quot; src=&quot;&#39;</span>
        <span class="n">script_tags</span> <span class="o">+=</span> <span class="n">js_file</span> <span class="o">+</span> <span class="s">&#39;&quot;&gt;&lt;/script&gt;&#39;</span>
        <span class="n">script_tags</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    
    <span class="k">return</span> <span class="n">script_tags</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Handles creating the script tags for production.
If the js_file_name isn't passed in, the last js file name
passed in the list js_file will be used to name the prod
js file.</p>
<p>For example the following function call:
    js_script(env, ['jquery.js', 'jquery.someplugin.js', '/subfolder/form.js'])</p>
<p>from the template file named home.html
    /prodjs/subfolder/home.js</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@contextfilter</span>
<span class="k">def</span> <span class="nf">js_script</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">js_files</span><span class="p">,</span> <span class="n">js_file_name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">registry</span> <span class="o">=</span> <span class="n">threadlocal</span><span class="o">.</span><span class="n">get_current_registry</span><span class="p">()</span>
    <span class="n">prodjs_path</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;prod_js_path&#39;</span><span class="p">]</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">get_version_from_env</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">prodjs_path</span><span class="p">)</span>
    <span class="n">prod_filename</span> <span class="o">=</span> <span class="n">get_prod_filename</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">prodjs_path</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    
    <span class="n">script_tag</span> <span class="o">=</span> <span class="s">&#39;&lt;script type=&quot;text/javascript&quot; src=&quot;&#39;</span>
    <span class="n">script_tag</span><span class="o">+=</span> <span class="s">&#39;/prodjs/&#39;</span> <span class="o">+</span> <span class="n">prod_filename</span> <span class="o">+</span> <span class="s">&#39;&quot;&gt;&lt;/script&gt;&#39;</span>
    
    <span class="k">return</span> <span class="n">script_tag</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_version_from_env</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">prodjs_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;js_version&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;js_version&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>get version, save to env</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">version</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">clean_path</span><span class="p">(</span><span class="n">prodjs_path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">VERSION_FILE</span><span class="p">))</span>
        <span class="n">env</span><span class="o">.</span><span class="n">globals</span><span class="p">[</span><span class="s">&#39;js_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
        
        <span class="k">return</span> <span class="n">version</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">get_prod_filename</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">,</span> <span class="n">prodjs_path</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">tpl_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">version</span> <span class="o">+</span> <span class="s">&#39;.js&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">contents</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s">&#39; is not a file&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Ensure we don't get any double forward slashes if 
ini settings are entered incorrectly</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">clean_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>MINIFY PROJECT FILES</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">MinifyProject</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tpl_path</span><span class="p">,</span> <span class="n">js_path</span><span class="p">,</span> <span class="n">prodjs_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tpl_path</span> <span class="o">=</span> <span class="n">tpl_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">js_path</span> <span class="o">=</span> <span class="n">js_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prodjs_path</span> <span class="o">=</span> <span class="n">prodjs_path</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Find all the js_script filters embedded in template files.
Find the scripts in the js folder and minify them into a single js file
named after the template they were created for.</p>
<p>For example the template home_page.html with the following filter:
    {{ ['/js/jquery.js', '/js/home.js']|js_script|safe }}</p>
<p>Will create a production file named:
    /prodjs/home_page.[version].js</p>
<p>The version number is stored in the /prodjs/version.txt file.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">minify_all_js_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_prodjs_dir</span><span class="p">()</span>
        
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_project_files</span><span class="p">()</span>
        <span class="n">filenames_to_scripts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename_to_scripts</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">scripts</span> <span class="ow">in</span> <span class="n">filenames_to_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_minify_page_scripts</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">scripts</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Prepare the /prodjs/ directory for minification</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_prep_prodjs_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Remove all the files in this directory</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prodjs_path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Make sure the prod js dir exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prodjs_path</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Make the /prodjs/version.txt file and save current unix timestamp</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">version_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">clean_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prodjs_path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">VERSION_FILE</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">version_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="n">version_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Builds a list of all the template files that need to
be searched for js_scripts</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_index_project_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span> <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_path</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Ignore directories that start with a dot</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;/.&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_approved_file_type</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                        <span class="n">path_to_file</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file_name</span>
                        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">files</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_is_approved_file_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="n">is_approved</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="k">for</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">TPL_FILE_TYPES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ftype</span><span class="p">):</span>
                <span class="n">is_approved</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
        
        <span class="k">return</span> <span class="n">is_approved</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Roll through the project files and find the scripts.
Add to the dict, with format:
    { filename: [list_of_js_files] }</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_filename_to_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">filenames_to_scripts</span> <span class="o">=</span> <span class="p">{</span> <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">js_scripts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_js_scripts</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">js_scripts</span><span class="p">:</span>
                <span class="n">filenames_to_scripts</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">js_scripts</span>
        
        <span class="k">return</span> <span class="n">filenames_to_scripts</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Find the js_scripts embedded in our templates
    ex. ['/js/jquery.js', '/js/bootstrap-dropdown.js', '/js/doula.js']</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_find_js_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">regex</span> <span class="o">=</span> <span class="s">r&#39;\[(.*)\]|js_script&#39;</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_clean_contents</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
        <span class="n">js_scripts</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">js_scripts</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">js_scripts</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>Read the contents of the file into a single string.
Replace all new line characters with a space so that
we can run regex on the entire file as a single string</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_clean_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">contents</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;\s+&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_minify_page_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">scripts</span><span class="p">):</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cleaned_scripts</span><span class="p">(</span><span class="n">scripts</span><span class="p">)</span>
        <span class="n">minified_js</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_minified_js</span><span class="p">(</span><span class="n">scripts</span><span class="p">)</span>
        <span class="n">prod_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_prod_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_prod_file</span><span class="p">(</span><span class="n">prod_filename</span><span class="p">,</span> <span class="n">minified_js</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Return string '/js/jquery.js', '/js/home.js'
as list of individual strings split by commas</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_cleaned_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scripts</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">scripts_list</span> <span class="o">=</span> <span class="n">scripts</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">scripts</span> <span class="o">=</span> <span class="p">[</span><span class="n">script</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
                    <span class="k">for</span> <span class="n">script</span> <span class="ow">in</span> <span class="n">scripts_list</span> <span class="p">]</span>
        
        <span class="k">return</span> <span class="n">scripts</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Minify js files in the list as a single file.
Roll through the js_files, read their contents,
put them into a single string for writing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_minified_js</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">js_files</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">minified_js</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">js_file</span> <span class="ow">in</span> <span class="n">js_files</span><span class="p">:</span>
            <span class="n">js_file_path</span> <span class="o">=</span> <span class="n">clean_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">js_path</span> <span class="o">+</span> <span class="n">js_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/js&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="n">js_contents</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">js_file_path</span><span class="p">)</span>
            
            <span class="n">minified_js</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsmin</span><span class="p">(</span><span class="n">js_contents</span><span class="p">))</span>
            <span class="n">minified_js</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">minified_js</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>Return the production file name:
    Format template_name.version.js</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_prod_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">rel</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpl_path</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">prod_file</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">prod_file</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.js&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="n">clean_path</span><span class="p">(</span><span class="n">prodjs_path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">VERSION_FILE</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_create_prod_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prod_filename</span><span class="p">,</span> <span class="n">minified_js</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>Actually write the minified files</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">prod_file</span> <span class="o">=</span> <span class="n">clean_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prodjs_path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">prod_filename</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Make sure the prod js dir exists</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">prod_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">prod_file</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">prod_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">prod_dir</span><span class="p">)</span>
        
        <span class="n">prod_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">prod_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">prod_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">minified_js</span><span class="p">)</span>
        <span class="n">prod_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/Users/alexvazquezOLD/boxes/doula&#39;</span>
    <span class="n">tpl_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;/doula/templates/&#39;</span>
    <span class="n">js_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;/doula/static/js/&#39;</span>
    <span class="n">prodjs_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;/doula/static/prodjs/&#39;</span>
    
    <span class="k">print</span> <span class="s">&#39;Minifying ...&#39;</span>
    <span class="n">mp</span> <span class="o">=</span> <span class="n">MinifyProject</span><span class="p">(</span><span class="n">tpl_path</span><span class="p">,</span> <span class="n">js_path</span><span class="p">,</span> <span class="n">prodjs_path</span><span class="p">)</span>
    <span class="n">mp</span><span class="o">.</span><span class="n">minify_all_js_files</span><span class="p">()</span>
    
    <span class="k">print</span> <span class="s">&#39;Done minifying&#39;</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
<script src="pycco.js"></script>
</body>
